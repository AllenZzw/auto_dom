\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{mznstyle}[2016/12/18 LaTeX package (MiniZinc for Sphinx)]

\RequirePackage{trace}
\RequirePackage[breakable]{tcolorbox}
\RequirePackage{caption}
\PassOptionsToPackage{hanging,nooneline}{caption}

\RequirePackage{chngcntr}

\counterwithin{chapter}{part}
\renewcommand{\thepart}{\arabic{part}}

%\definecolor{UglyGreen}{rgb}{0,1,0}
\definecolor{UglyGreen}{rgb}{0.418,0.556,0.137}
%\definecolor{UglyBlue}{rgb}{0,0,1}
\definecolor{UglyBlue}{rgb}{0.273,0.508,0.703}
%\definecolor{UglyRed}{rgb}{0.2,0,0}
\definecolor{UglyRed}{rgb}{0.801,0.359,0.359}
%\definecolor{UglyOrange}{rgb}{0.2,0,0}
\definecolor{UglyOrange}{rgb}{0.930,0.906,0.664}

\DeclareCaptionFont{white}{\color{white}}

\renewenvironment{sphinxadmonition}[2]{
  \begin{tcolorbox}[colbacktitle=UglyBlue,coltitle=white,colframe=UglyBlue,fonttitle=\bfseries\large,title=#2]
}{\end{tcolorbox}}

\tcbset{boxrule=0.4pt}

\newtcolorbox[auto counter,number within=chapter]{codebox}[2][]{% 
  title=\textbf{Listing~\thetcbcounter:} #2,#1}

\renewenvironment{sphinxVerbatim}{%
  % % quit horizontal mode if we are still in a paragraph
  % \par
  % % list starts new par, but we don't want it to be set apart vertically
  % \parskip\z@skip
  % % first, let's check if there is a caption
  % \ifx\sphinxVerbatimTitle\empty
  %     \addvspace\z@% counteract possible previous negative skip (French lists!)
  %     \smallskip
  %     % there was no caption. Check if nevertheless a label was set.
  %     \ifx\sphinxLiteralBlockLabel\empty\else
  %     % we require some space to be sure hyperlink target from \phantomsection
  %     % will not be separated from upcoming verbatim by a page break
  %         \needspace{\sphinxliteralblockwithoutcaptionneedspace}%
  %         \phantomsection\sphinxLiteralBlockLabel
  %     \fi
  %     \let\spx@Verbatim@Title\@empty
  % \else
  % % non-empty \sphinxVerbatimTitle has label inside it (in case there is one)
  %    \setbox\spx@Verbatim@TitleBox
  %           \hbox{\begin{minipage}{\linewidth}%
  %                   \sphinxVerbatimTitle
  %                 \end{minipage}}%
  % \fi
  % \fboxsep\sphinxverbatimsep \fboxrule\sphinxverbatimborder
  % % setting borderwidth to zero is simplest for no-frame effect with same pagebreaks
  % \ifspx@opt@verbatimwithframe\else\fboxrule\z@\fi
  % \let\FrameCommand     \spx@Verbatim@FrameCommand
  % \let\FirstFrameCommand\spx@Verbatim@FirstFrameCommand
  % \let\MidFrameCommand  \spx@Verbatim@MidFrameCommand
  % \let\LastFrameCommand \spx@Verbatim@LastFrameCommand
  % \ifspx@opt@verbatimhintsturnover\else
  %     \let\spx@Verbatim@Continued\@empty
  %     \let\spx@Verbatim@Continues\@empty
  % \fi
  % \ifspx@opt@verbatimwrapslines
  % fancyvrb's Verbatim puts each input line in (unbreakable) horizontal boxes.
  % This customization wraps each line from the input in a \vtop, thus
  % allowing it to wrap and display on two or more lines in the latex output.
  %     - The codeline counter will be increased only once.
  %     - The wrapped material will not break across pages, it is impossible
  %       to achieve this without extensive rewrite of fancyvrb.
  %     - The (not used in sphinx) obeytabs option to Verbatim is
  %       broken by this change (showtabs and tabspace work).
  % \expandafter\def\expandafter\FV@SetupFont\expandafter
  %   {\FV@SetupFont\sbox\sphinxcontinuationbox {\spx@opt@verbatimcontinued}%
  %                 \sbox\sphinxvisiblespacebox {\spx@opt@verbatimvisiblespace}}%
  % \def\FancyVerbFormatLine ##1{\hsize\linewidth
  %         \vtop{\raggedright\hyphenpenalty\z@\exhyphenpenalty\z@
  %               \doublehyphendemerits\z@\finalhyphendemerits\z@
  %               \strut ##1\strut}%
  %         }%
  % \let\FV@Space\spx@verbatim@space
  % % Allow breaks at special characters using \PYG... macros.
  % \sphinxbreaksatspecials
  % % Breaks at punctuation characters . , ; ? ! and / (needs catcode activation)
  % \def\FancyVerbCodes{\sphinxbreaksviaactive}%
  % \fi % end of conditional code for wrapping long code lines
  % go around fancyvrb's check of \@currenvir
  \let\VerbatimEnvironment\sphinxVerbatimEnvironment
  % go around fancyvrb's check of current list depth
  \def\@toodeep {\advance\@listdepth\@ne}%
  % The list environment is needed to control perfectly the vertical space.
  % Note: \OuterFrameSep used by framed.sty is later set to \topsep hence 0pt.
  % - if caption: vertical space above caption = (\abovecaptionskip + D) with
  %   D = \baselineskip-\FrameHeightAdjust, and then \smallskip above frame.
  % - if no caption: (\smallskip + D) above frame. By default D=6pt.
  % Use trivlist rather than list to avoid possible "too deeply nested" error.
  \itemsep   \z@skip
  \topsep    \z@skip
  \partopsep \z@skip% trivlist will set \parsep to \parskip = zero (see above)
  % \leftmargin will be set to zero by trivlist
  \rightmargin\z@
  \parindent  \z@% becomes \itemindent. Default zero, but perhaps overwritten.
  \trivlist\item\relax
     \ifsphinxverbatimwithminipage\spx@inframedtrue\fi
     % use a minipage if we are already inside a framed environment
     \ifspx@inframed\noindent\begin{minipage}{\linewidth}\fi
     \ifx\sphinxVerbatimTitle\empty
       \begin{tcolorbox}[breakable,toprule at break=0pt,bottomrule at break=0pt,pad at break*=2mm]
     \else
       % \show\sphinxVerbatimTitle
       % \begin{codebox}{\sphinxLiteralBlockLabel \sphinxVerbatimTitle}
       \captionsetup{aboveskip=0pt,belowskip=0pt,justification=raggedright,singlelinecheck=false,font=white}
       % \traceon
\begin{tcolorbox}[breakable,,toprule at break=0pt,bottomrule at break=0pt,pad at break*=2mm,title={\sphinxVerbatimTitle}]
      % \traceoff
     \fi
     \small
     % For grid placement from \strut's in \FancyVerbFormatLine
     \lineskip\z@skip
     % active comma should not be overwritten by \@noligs
     \ifspx@opt@verbatimwrapslines
       \let\verbatim@nolig@list \sphinx@verbatim@nolig@list
     \fi
     % will fetch its optional arguments if any
     \OriginalVerbatim
}
{%
  \endOriginalVerbatim
  % \par\unskip\@minipagefalse\endMakeFramed % from framed.sty snugshade
     \ifx\sphinxVerbatimTitle\empty
       \end{tcolorbox}
     \else
       \end{tcolorbox}
       % \end{codebox}
     \fi
  \ifspx@inframed\end{minipage}\fi
  \endtrivlist
}
